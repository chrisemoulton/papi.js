'use strict';

var _isEmpty = require('lodash/lang/isEmpty');

var _isEmpty2 = _interopRequireDefault(_isEmpty);

var _extend = require('lodash/object/extend');

var _extend2 = _interopRequireDefault(_extend);

var _promiscuous = require('promiscuous');

var _promiscuous2 = _interopRequireDefault(_promiscuous);

var _isomorphicFetch = require('isomorphic-fetch');

var _isomorphicFetch2 = _interopRequireDefault(_isomorphicFetch);

var _querystring = require('querystring');

var _querystring2 = _interopRequireDefault(_querystring);

var _resourceSchema = require('./resource-schema');

var _resourceSchema2 = _interopRequireDefault(_resourceSchema);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _possibleConstructorReturn(self, call) { if (!self) { throw new ReferenceError("this hasn't been initialised - super() hasn't been called"); } return call && (typeof call === "object" || typeof call === "function") ? call : self; }

function _inherits(subClass, superClass) { if (typeof superClass !== "function" && superClass !== null) { throw new TypeError("Super expression must either be null or a function, not " + typeof superClass); } subClass.prototype = Object.create(superClass && superClass.prototype, { constructor: { value: subClass, enumerable: false, writable: true, configurable: true } }); if (superClass) Object.setPrototypeOf ? Object.setPrototypeOf(subClass, superClass) : subClass.__proto__ = superClass; }

if (!global.Promise) {
  global.Promise = _promiscuous2.default;
}

var AbortablePromise = require('dodgy');

if (!global.fetch) {
  global.fetch = _isomorphicFetch2.default;
}

// Query string parser and stringifier -- fetch does not support any query string
// parsing so we need to handle it separately.

function hasXDomain() {
  return typeof window !== 'undefined' && window.xdomain != null;
}

var Papi = function (_ResourceSchema) {
  _inherits(Papi, _ResourceSchema);

  function Papi() {
    var options = arguments.length <= 0 || arguments[0] === undefined ? {} : arguments[0];

    _classCallCheck(this, Papi);

    var _this = _possibleConstructorReturn(this, _ResourceSchema.apply(this, arguments));

    _this.options = options;
    _this.options.host = options.host || 'https://api.pressly.com';

    if (hasXDomain()) {
      var slaves = {};
      slaves[_this.options.host] = '/proxy.html';
      window.xdomain.slaves(slaves);
    }

    _this.requestMiddlewares = [];
    _this.responseMiddlewares = [];

    _this.auth = {
      session: null,

      get: function get() {
        return _this.request('get', '/session').then(function (res) {
          return _this.auth.set(res.data);
        });
      },

      set: function set(session) {
        if (!session.jwt) {
          throw new Error('Papi:Auth: Invalid session response - missing jwt');
        }

        _this.auth.session = session;

        return _this.auth.session;
      },

      isLoggedIn: function isLoggedIn() {
        return !!_this.auth.session && !_this.auth.isExpired();
      },

      isExpired: function isExpired() {
        // XXX this should be using a jwt lib to figure out if the token has expired
        // XXX We do not currently include an expiry param in our tokens so just return false.
        return false;
      },

      login: function login(email, password) {
        return _this.request('post', '/auth/login', { data: { email: email, password: password } }).then(function (res) {
          return _this.auth.set(res.data);
        });
      },

      requestPasswordReset: function requestPasswordReset(email) {
        return _this.request('post', '/auth/password_reset/send', { data: { email: email } });
      },

      logout: function logout() {
        return _this.request('delete', '/session').then(function (res) {
          _this.auth.session = null;

          return res;
        });
      }
    };
    return _this;
  }

  Papi.prototype.request = function request(method, path) {
    var _this2 = this;

    var options = arguments.length <= 2 || arguments[2] === undefined ? {} : arguments[2];

    return new AbortablePromise(function (resolve, reject, onAbort) {
      var url = /^(https?:)?\/\//.test(path) ? path : _this2.options.host + path;

      var req = {
        url: url,
        method: method,
        headers: {},
        query: {}
      };

      req.headers['Content-Type'] = 'application/json';

      // if (options.timeout || this.options.timeout) {
      //   req.timeout(options.timeout || this.options.timeout);
      // }

      // Allow sending cookies from origin
      if (typeof req.withCredentials == 'function' && !hasXDomain()) {
        req.credentials = 'include';
      }

      // Send Authorization header when we have a JSON Web Token set in the session
      if (_this2.auth.session && _this2.auth.session.jwt) {
        req.headers['Authorization'] = 'Bearer ' + _this2.auth.session.jwt;
      }

      req.headers['Accept'] = 'application/vnd.pressly.v0.12+json';

      // Query params to be added to the url
      if (options.query) {
        (0, _extend2.default)(req.query, options.query);
      }

      // Data to send (with get requests these are converted into query params)
      if (options.data) {
        if (method == 'get') {
          (0, _extend2.default)(req.query, options.data);
        } else {
          req.body = JSON.stringify(options.data);
        }
      }

      if (!(0, _isEmpty2.default)(req.query)) {
        req.url += '?' + _querystring2.default.stringify(req.query);
      }

      var res = {};

      var beginRequest = function beginRequest() {
        if (_this2.requestMiddlewares.length) {
          var offset = 0;
          var next = function next() {
            var layer = _this2.requestMiddlewares[++offset] || endRequest;
            return layer(req, res, next, resolve, reject);
          };

          _this2.requestMiddlewares[0](req, res, next, resolve, reject);
        } else {
          endRequest();
        }
      };

      var endRequest = function endRequest() {
        // XXX this is where the request will be made
        fetch(req.url, req).then(function (response) {
          if (response.status >= 200 && response.status < 300) {
            res = response;

            response.json().then(function (data) {
              res.data = data || {};
            }).catch(function (err) {
              res.data = {};
            }).then(function () {
              beginResponse();
            });
          } else {
            return reject(response);
          }
        }).catch(function (err) {
          return reject(err);
        });
      };

      var beginResponse = function beginResponse() {
        if (_this2.responseMiddlewares.length) {
          var offset = 0;
          var next = function next() {
            var layer = _this2.responseMiddlewares[++offset] || endResponse;
            return layer(req, res, next, resolve, reject);
          };

          _this2.responseMiddlewares[0](req, res, next, resolve, reject);
        } else {
          endResponse();
        }
      };

      var endResponse = function endResponse() {
        resolve(res);
      };

      onAbort(function (why) {});

      beginRequest();
    });
  };

  Papi.prototype.before = function before(middleware) {
    this.requestMiddlewares.push(middleware);
  };

  Papi.prototype.after = function after(middleware) {
    this.responseMiddlewares.push(middleware);
  };

  return Papi;
}(_resourceSchema2.default);

module.exports = Papi;

// <= IE10, does not support static method inheritance
if (Papi.defineSchema == undefined) {
  Papi.defineSchema = _resourceSchema2.default.defineSchema;
}

Papi.defineSchema().resource('accounts').open().get('available', { on: 'resource' }).post('become', { on: 'member' }).resource('users').resource('hubs', { link: 'hubs' }).close().resource('organizations').open().resource('users').resource('hubs').resource('invites').open().post('bulk_invite', { on: 'resource' }).post('resend', { on: 'member' }).put('accept', { on: 'member', routeSegment: '/invites/:hash' }).put('reject', { on: 'member', routeSegment: '/invites/:hash' }).close().close().resource('activity').resource('posts', { routeSegment: '/stream/posts/:id' }).resource('hubs').open().get('search', { on: 'resource' }).post('upgrade', { on: 'member' }).resource('apps').open().get('current', { on: 'resource' }).get('build', { on: 'member', path: '/build_app' }).get('status', { on: 'member' }).resource('styles').close().resource('addons').open().resource('configs').close().resource('analytics').open().get('summary', { on: 'resource' }).get('visitors', { on: 'resource' }).get('pageviews', { on: 'resource' }).get('duration', { on: 'resource' }).close().resource('feeds').open().resource('assets', { modelName: 'FeedAsset' }).close().resource('invites').open().post('bulk_invite', { on: 'resource' }).post('resend', { on: 'member' }).put('accept', { on: 'member', routeSegment: '/invites/:hash' }).put('reject', { on: 'member', routeSegment: '/invites/:hash' }).close().resource('recommendations').resource('users').open().post('grant_access', { on: 'resource' }).delete('revoke_access', { on: 'member' }).close().resource('collections').open().put('reorder', { on: 'resource' }).close().resource('tags').resource('assets', { routeSegment: '/stream/:id' }).open().put('feature', { on: 'member' }).put('unfeature', { on: 'member' }).put('hide', { on: 'member' }).put('unhide', { on: 'member' }).put('lock', { on: 'member' }).put('unlock', { on: 'member' }).resource('likes').resource('comments').close().resource('drafts').open().put('publish', { on: 'member' }).close().close().resource('invites').open().get('incoming', { on: 'resource' }).get('outgoing', { on: 'resource' }).post('bulk_invite', { on: 'resource' }).post('resend', { on: 'member' }).put('accept', { on: 'member', routeSegment: '/invites/:hash' }).put('reject', { on: 'member', routeSegment: '/invites/:hash' }).close().resource('code_revisions').open().get('fetch_repo', { on: 'member' })

// This resource links to the root hubs resource
.resource('hubs', { link: 'hubs' }).close().resource('signup').open().get('account_uid_available', { on: 'member' }).get('account_email_available', { on: 'member' }).close().resource('users').open().get('roles', { on: 'resource' }).resource('hubs').resource('organizations').close().resource('discover').open().resource('users', { link: 'users' }).resource('organizations', { link: 'organizations' }).resource('hubs', { link: 'hubs' }).resource('posts').close().resource('stream').open().resource('following').close();